name: stremiotorrentbridge

services:
# Web UI Proxy (nginx-hash-lock protection)
  stremiotorrentbridge:
    image: ghcr.io/yundera/nginx-hash-lock:latest
    container_name: stremio-bridge-ui
    hostname: stremiobridge
    restart: unless-stopped
    cpu_shares: 80
    user: "root"
    expose:
      - 80
    environment:
      BACKEND_HOST: "bridge"
      BACKEND_PORT: "8080"
      LISTEN_PORT: "80"
      AUTH_HASH: "$AUTH_HASH"
      ALLOWED_PATHS: "wrap,stream,sw"
    tmpfs:
      - /var/cache/nginx:size=100M
    depends_on:
      - bridge
    networks:
      - pcs

  # Bridge Service (Addon Wrapper + Router)
  bridge:
    image: ghcr.io/krizcold/stremio-torrent-bridge:latest
    container_name: stremio-bridge
    restart: unless-stopped
    cpu_shares: 80
    user: "1000:1000"
    expose:
      - 8080
    extra_hosts:
      - "torrserver:host-gateway"
      - "rqbit:host-gateway"
      - "qbittorrent:host-gateway"
    environment:
      TORRENT_ENGINE: "${TORRENT_ENGINE:-qbittorrent}"
      BRIDGE_EXTERNAL_URL: "https://stremiotorrentbridge-${PCS_DOMAIN}"
      TORRSERVER_URL: "http://torrserver:8090"
      TORRSERVER_USERNAME: "bridge"
      TORRSERVER_PASSWORD: "$PCS_DEFAULT_PASSWORD"
      RQBIT_URL: "http://rqbit:3030"
      RQBIT_USERNAME: "bridge"
      RQBIT_PASSWORD: "$PCS_DEFAULT_PASSWORD"
      QBITTORRENT_URL: "http://qbittorrent:8080"
      QBITTORRENT_DOWNLOAD_PATH: "/downloads"
      QBITTORRENT_USERNAME: "admin"
      QBITTORRENT_PASSWORD: "$PCS_DEFAULT_PASSWORD"
      CACHE_SIZE_GB: "${CACHE_SIZE_GB:-60}"
      CACHE_MAX_AGE_DAYS: "${CACHE_MAX_AGE_DAYS:-7}"
      TZ: "$TZ"
    volumes:
      - /DATA/AppData/stremiotorrentbridge/bridge:/data
      - /DATA/AppData/stremiotorrentbridge/qbittorrent/downloads:/downloads:ro
    depends_on:
      - torrserver
    networks:
      - pcs
    x-casaos:
      envs:
        - container: TORRENT_ENGINE
          description:
            en_us: "Torrent engine to use: torrserver, rqbit, or qbittorrent"
        - container: CACHE_SIZE_GB
          description:
            en_us: "Maximum cache size in gigabytes"
        - container: CACHE_MAX_AGE_DAYS
          description:
            en_us: "Maximum days to keep unused cached torrents"
      volumes:
        - container: /data
          description:
            en_us: "Bridge configuration and addon data"

  # Engine A: TorrServer
  torrserver:
    image: ghcr.io/yourok/torrserver:MatriX.137
    container_name: stremio-bridge-torrserver
    restart: unless-stopped
    cpu_shares: 50
    network_mode: host
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        printf '{"bridge":"%s"}' "$$TS_AUTH_PASSWORD" > "$$TS_CONF_PATH/accs.db"
        PUB_IPV6=$$(wget -qO- https://api6.ipify.org 2>/dev/null || true)
        mkdir -p "$$TS_CONF_PATH" "$$TS_TORR_DIR"
        touch "$$TS_LOG_PATH"
        printf '%s' '{"BitTorr":{"CacheSize":268435456,"ReaderReadAHead":95,"PreloadCache":5,"UseDisk":true,"TorrentsSavePath":"","RemoveCacheOnDrop":false,"ForceEncrypt":false,"RetrackersMode":1,"TorrentDisconnectTimeout":300,"EnableDebug":false,"EnableDLNA":false,"FriendlyName":"","EnableRutorSearch":false,"EnableTorznabSearch":false,"TorznabUrls":null,"EnableIPv6":true,"DisableTCP":false,"DisableUTP":false,"DisableUPNP":false,"DisableDHT":false,"DisablePEX":false,"DisableUpload":false,"DownloadRateLimit":0,"UploadRateLimit":0,"ConnectionsLimit":150,"PeersListenPort":42069,"SslPort":0,"SslCert":"","SslKey":"","ResponsiveMode":true,"ShowFSActiveTorr":true,"StoreSettingsInJson":true,"StoreViewedInJson":false}}' > "$$TS_CONF_PATH/settings.json"
        FLAGS="--path $$TS_CONF_PATH --logpath $$TS_LOG_PATH --port $$TS_PORT --torrentsdir $$TS_TORR_DIR --dontkill --httpauth"
        [ -n "$$PUB_IPV6" ] && FLAGS="$$FLAGS --pubipv6 $$PUB_IPV6"
        echo "Running with: $$FLAGS"
        exec torrserver $$FLAGS
    environment:
      TS_PORT: "8090"
      TS_DONTKILL: "1"
      TS_HTTPAUTH: "1"
      TS_AUTH_PASSWORD: "$PCS_DEFAULT_PASSWORD"
    volumes:
      - /DATA/AppData/stremiotorrentbridge/torrserver/config:/opt/ts/config
      - /DATA/AppData/stremiotorrentbridge/torrserver/cache:/opt/ts/torrents

  # Engine B: rqbit
  rqbit:
    image: ikatson/rqbit:9.0.0-beta.2
    container_name: stremio-bridge-rqbit
    restart: unless-stopped
    cpu_shares: 50
    network_mode: host
    command: server start --listen-port 4240 /downloads
    environment:
      RQBIT_HTTP_BASIC_AUTH_USERPASS: "bridge:$PCS_DEFAULT_PASSWORD"
    volumes:
      - /DATA/AppData/stremiotorrentbridge/rqbit/downloads:/downloads
      - /DATA/AppData/stremiotorrentbridge/rqbit/config:/root/.config/rqbit

  # Engine C: qBittorrent
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:5.1.4
    container_name: stremio-bridge-qbittorrent
    restart: unless-stopped
    cpu_shares: 50
    network_mode: host
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        mkdir -p /config/qBittorrent
        cat << 'PYEOF' > /tmp/qbt_config.py
        import hashlib, os, base64, sys, pathlib
        password = sys.argv[1].encode()
        salt = os.urandom(16)
        dk = hashlib.pbkdf2_hmac('sha512', password, salt, 100000)
        pw_hash = '@ByteArray(' + base64.b64encode(salt).decode() + ':' + base64.b64encode(dk).decode() + ')'
        config = '[LegalNotice]\nAccepted=true\n\n[Preferences]\n'
        config += 'WebUI\\Port=8080\n'
        config += 'WebUI\\Username=admin\n'
        config += 'WebUI\\Password_PBKDF2=' + pw_hash + '\n'
        config += 'WebUI\\HostHeaderValidation=false\n'
        config += 'WebUI\\CSRFProtection=false\n'
        config += 'WebUI\\ServerDomains=*\n'
        config += 'WebUI\\Address=*\n'
        config += 'Connection\\PortRangeMin=6881\n'
        config += 'Connection\\UPnP=false\n'
        config += 'Bittorrent\\MaxConnecs=500\n'
        config += 'Bittorrent\\MaxConnecsPerTorrent=100\n'
        config += 'Queueing\\QueueingEnabled=false\n'
        config += 'Downloads\\SavePath=/downloads/\n'
        pathlib.Path('/config/qBittorrent/qBittorrent.conf').write_text(config)
        print('Password hash: ' + pw_hash)
        PYEOF
        python3 /tmp/qbt_config.py "$$QBT_PASSWORD"
        echo "qBittorrent config written, starting init..."
        exec /init
    environment:
      PUID: "$PUID"
      PGID: "$PGID"
      TZ: "$TZ"
      WEBUI_PORT: "8080"
      QBT_PASSWORD: "$PCS_DEFAULT_PASSWORD"
    volumes:
      - /DATA/AppData/stremiotorrentbridge/qbittorrent/config:/config
      - /DATA/AppData/stremiotorrentbridge/qbittorrent/downloads:/downloads

networks:
  pcs:
    external: true

x-casaos:
  architectures:
    - amd64
    - arm64
  main: stremiotorrentbridge
  author: kriz_cold
  developer: kriz_cold
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/stremio-torrent-bridge/icon.png
  tagline:
    en_us: "Full-peer torrent streaming for Stremio"
  category: Entertainment
  description:
    en_us: |
      Stremio Torrent Bridge wraps Stremio addons (like Torrentio) to provide
      enhanced torrent streaming with full TCP/UDP peer connectivity, solving
      Stremio's built-in WebRTC limitation that only connects to ~2% of peers.

      Features:
      - Wrap any Stremio addon for full peer connectivity
      - Triple-engine: TorrServer (default), rqbit (low memory), qBittorrent (max speed)
      - HTTP streaming with seek support (Range requests)
      - Automatic LRU cache management
      - Management UI for addon configuration

      Default engine: TorrServer
      Change via TORRENT_ENGINE environment variable on "bridge" service.
  title:
    en_us: "Stremio Torrent Bridge"
  is_uncontrolled: false
  index: /?hash=$AUTH_HASH
  port_map: "80"
  tips:
    before_install:
      en_us: |
        Access: `https://${REF_DOMAIN}/`

        1. Open the Bridge UI
        2. Paste a Stremio addon manifest URL (e.g., Torrentio)
        3. Copy the wrapped URL and install it in Stremio
        4. Enjoy full peer connectivity!

        Change the torrent engine via TORRENT_ENGINE on the "bridge" service:
        - `torrserver` (default) - Easy setup, IPv6 support
        - `rqbit` - Low memory usage, great for Raspberry Pi
        - `qbittorrent` - Maximum download speed, ISP throttle bypass
